{% extends "base.html" %}
{% from "macros.html" import error_container, submit_button %}

{% block title %}Set Up Password - Chronicle{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='login.css') }}">
{% endblock %}

{# No navigation on this page #}
{% block nav %}{% endblock %}

{% block main_class %}page-centered{% endblock %}

{% block content %}
<div class="card-container">
  <div class="glass-card">
    <h1>Welcome to Chronicle!</h1>
    <p class="subtitle">Your subscription is active. Create a password to secure your account.</p>

    {{ error_container() }}

    <form id="authForm">
      <div class="form-group">
        <label for="password">Create Password</label>
        <input type="password" id="password" name="password" class="form-input" placeholder="••••••••" required autocomplete="new-password">
        <div class="password-hint show">Password must be at least 8 characters</div>
      </div>

      <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <input type="password" id="confirmPassword" name="confirmPassword" class="form-input" placeholder="••••••••" required autocomplete="new-password">
      </div>

      {{ submit_button("Set Password & Continue") }}
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const form = document.getElementById('authForm');
  const passwordInput = document.getElementById('password');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  const errorMessage = document.getElementById('errorMessage');
  const submitBtn = document.getElementById('submitBtn');

  function showError(message) {
    errorMessage.textContent = message;
    errorMessage.classList.add('show');
  }

  function hideError() {
    errorMessage.classList.remove('show');
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError();

    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;

    if (password.length < 8) {
      showError('Password must be at least 8 characters');
      return;
    }

    if (password !== confirmPassword) {
      showError('Passwords do not match');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Setting up...';

    try {
      const response = await fetch('/setup-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });

      const data = await response.json();

      if (data.success) {
        window.location.href = data.redirect;
      } else {
        showError(data.error || 'An error occurred');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Set Password & Continue';
      }
    } catch (error) {
      showError('An error occurred. Please try again.');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Set Password & Continue';
    }
  });
</script>
{% endblock %}
